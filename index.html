<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale = 1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Panorama COVID-19 in Italia</title>
    <meta name="description" content="Visualizzazione di dati e grafici sulla situazione in Italia della pandemia di COVID-19">
    <link rel="icon" type="image/x-icon" href="virus.ico">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script src="https://cdn.plot.ly/plotly-locale-it-latest.js"></script>
    <script>Plotly.setPlotConfig({locale: 'it'})</script>

    <noscript>
        <style>
            body *{
                visibility: hidden;
            }
            #noJs#noJs * {
                visibility: visible;
            }
        </style>
        <div class="m-5" id="noJs">
            <div class="card p-4">
                <p class="mt-2 text-danger text-center">JavaScript è disabilitato. Controlla le impostazioni del browser</p>
            </div>
        </div>
    </noscript>

</head>
<body class="bg-dark p-lg-5 p-md-4">

<div class="card m-lg-5 p-md-4 m-2 shadow-lg" id="app">

    <div class="p-3">
        <h2>Andamento pandemia COVID-19 in Italia</h2>
        <p v-if="nazionale.andamento.length>0" class="text-secondary">Dati aggiornati al {{ getFromEnd(nazionale.andamento,-1).data | formatDateDDMMYYYY }}</p>
    </div>

    <div class="row m-5" v-if="loadingError">
        <div class="col"></div>
        <div class="col">
            <p class="text-danger text-center">Il caricamento non è andato a buon fine...</p>
            <p class="text-danger text-center">Controlla di essere connesso ad internet</p>
        </div>
        <div class="col"></div>
    </div>

    <ul class="nav nav-pills m-1" id="tab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="nazionale-tab" data-toggle="tab" href="#nazionale" role="tab" aria-controls="nazionale" aria-selected="true">Nazione</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="regioni-tab" data-toggle="tab" href="#regioni" role="tab" aria-controls="regioni" aria-selected="false">Regioni</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="province-tab" data-toggle="tab" href="#province" role="tab" aria-controls="province" aria-selected="false">Province</a>
        </li>
    </ul>

    <div class="container-fluid py-5 my-2 my-lg-5" v-if="nazionale.andamento.length===0 && !loadingError">
        <div class="row">
            <div class="col"></div>
            <div class="col text-center">
                <div class="spinner-border m-2" role="status">
                    <span class="sr-only">Loading...</span></div>
            </div>
            <div class="col"></div>
        </div>
        <div class="row">
            <div class="col"></div>
            <div class="col">
                <p class="text-dark text-center">Caricamento</p>
            </div>
            <div class="col"></div>
        </div>
    </div>

    <div class="tab-content" id="tabContent">
        <div class="tab-pane fade show active" id="nazionale" role="tabpanel" aria-labelledby="nazionale-tab">

            <div class="row px-lg-5 py-4">

                <div class="col-lg">
                    <div id="andamentoNazionale"></div>
                    <div class="pr-lg-2 px-4" v-if="nazionale.andamentoLatest!==null">
                        <h4 class="pl-lg-5 py-2">Dati giornalieri</h4>
                        <table class="table table-striped table-sm">
                            <thead class="thead-dark">
                            <tr>
                                <th scope="col" class="pl-lg-5">Descrizione</th>
                                <th scope="col" class="text-right pr-lg-5">Dato</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="[key,value] in Object.entries(nazionale.andamentoLatest)">
                                <th scope="col" class="pl-lg-5">{{ key | formatString }}</th>
                                <td class="text-right pr-lg-5">{{ value | formatNumber }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="col-lg">
                    <div id="andamentoNazionalePercentuali"></div>
                    <div class="pl-lg-2 px-4" v-if="nazionale.andamentoLatest!==null">
                        <h4 class="pl-lg-5 py-2">Percentuali</h4>
                        <table class="table table-striped table-sm">
                            <thead class="thead-dark">
                            <tr>
                                <th scope="col" class="pl-lg-5">Descrizione</th>
                                <th scope="col" class="text-right pr-lg-5">Dato</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="[key, value] in Object.entries(nazionale.percentuali)">
                                <th scope="col" class="pl-lg-5">{{ key | formatString }}</th>
                                <td class="text-right pr-lg-5">{{ value | formatPercentage }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <div class="tab-pane fade show active" id="regioni" role="tabpanel" aria-labelledby="regioni-tab">
            <div class="px-lg-5"><div id="andamentoRegioni"></div></div>

            <div v-if="regioni.andamento.length>0" class="px-lg-5 px-5 input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                    <label class="input-group-text" for="regioneSelect">Regione</label>
                </div>
                <select id="regioneSelect" class="custom-select custom-select-sm col-sm-2" v-on:change="updateRegione">
                    <option v-for="r in regioni.regioni">{{ r }}</option>
                </select>
            </div>
        </div>

        <div class="tab-pane fade show active" id="province" role="tabpanel" aria-labelledby="province-tab">
            <div class="px-lg-5"><div id="andamentoProvince"></div></div>

            <div v-if="province.andamento.length>0" class="px-lg-5 px-5 input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                    <label class="input-group-text" for="provinciaSelect">Provincia</label>
                </div>
                <select id="provinciaSelect" class="custom-select custom-select-sm col-sm-2" v-on:change="updateProvincia">
                    <option v-for="r in province.province">{{ r }}</option>
                </select>
            </div>
        </div>
    </div>

</div>

</body>

<script src="utils.js"></script>
<script>
    const getLayout = function (title) {
        return {
            title: title,
            margin: {l: 50, t: 50, b: 100, r: 50},
            showlegend: true,
            legend: {
                orientation: 'h',
                x: 0,
                y: -0.15
            }
        }
    };

    const getConfig = function () {
        return {
            noJs: true,
            responsive: true,
            scrollZoom: false,
            displaylogo: false,
            displayModeBar: true,
            modeBarButtonsToRemove: ['toImage', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'hoverClosestCartesian', 'hoverCompareCartesian', 'toggleSpikelines']
        }
    };

    const getTrace = function (title, x, y, visible = true) {
        return {
            x: x,
            y: y,
            type: 'scatter',
            name: title,
            line: { shape: 'spline' },
            visible: visible ? true : 'legendonly'
        }
    };

    var app = new Vue({
        el: '#app',
        data: {
            data: [],
            nazionale: {
                url: 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-json/dpc-covid19-ita-andamento-nazionale.json',
                andamento: [],
                andamentoLatest: null,
                percentuali: {}
            },
            regioni: {
                url: 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-json/dpc-covid19-ita-regioni.json',
                andamento: [],
                regioni: []
            },
            province: {
                url: 'https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-json/dpc-covid19-ita-province.json',
                andamento: [],
                province: [],
            },
            loadingError: false,
            timer: null,
            mobileAccess: false,
        },
        methods: {
            getFromEnd,
            getData: function () {
                var self = this;
                $.get(this.nazionale.url, function (data) {
                    self.nazionale.andamento = JSON.parse(data);
                    self.processAndamentoNazionale();
                    self.processPercentuali();
                    self.plotAndamento(null, 'andamentoNazionale', 'Andamento nazionale');
                    self.plotAndamentoNazionalePercentuali();
                    clearTimeout(self.timer);
                    $('#tab').show()
                }).fail(function () {
                    self.loadingError = true
                });

                $.get(this.regioni.url, function (data) {
                    self.regioni.andamento = JSON.parse(data);
                    self.processAndamentoRegioni();
                    self.plotAndamento(self.regioni.regioni[0], 'andamentoRegioni', 'Andamento regione ' + self.regioni.regioni[0]);
                    $('#regioni').removeClass('show active');
                }).fail(function () {
                    self.loadingError = true
                });

                $.get(this.province.url, function (data) {
                    self.province.andamento = JSON.parse(data);
                    self.processAndamentoProvince();
                    self.plotAndamentoProvince(self.province.province[0]);
                    $('#province').removeClass('show active');
                }).fail(function () {
                    self.loadingError = true
                });
            },
            processAndamentoNazionale: function () {
                if (this.data.length === 0)
                    this.data = this.nazionale.andamento.map(e => e.data);

                var categorie = new Set([
                    "ricoverati_con_sintomi",
                    "terapia_intensiva",
                    "totale_ospedalizzati",
                    "isolamento_domiciliare",
                    "totale_positivi",
                    "variazione_totale_positivi",
                    "nuovi_positivi",
                    "dimessi_guariti",
                    "deceduti",
                    "casi_da_sospetto_diagnostico",
                    "casi_da_screening",
                    "totale_casi",
                    "tamponi",
                    "casi_testati"
                ]);

                this.nazionale.andamentoLatest = {};
                for ([key, value] of Object.entries(getFromEnd(this.nazionale.andamento,-1)))
                    if (categorie.has(key.toString()))
                        this.nazionale.andamentoLatest[key] = value;
            },
            processAndamentoRegioni: function () {
                if (this.data.length === 0)
                    this.data = this.nazionale.andamento.map(e => e.data);

                var reg = new Set();
                for (var e of this.regioni.andamento) {
                    if (reg.has(e.denominazione_regione))
                        break;
                    reg.add(e.denominazione_regione);
                    this.regioni.regioni.push(e.denominazione_regione);
                }
            },
            processAndamentoProvince: function () {
                if (this.data.length === 0)
                    this.data = this.nazionale.andamento.map(e => e.data);

                var prov = new Set();
                for (e of this.province.andamento) {
                    if (e.sigla_provincia != null)
                        prov.add(e.denominazione_provincia)
                }
                this.province.province = Array.from(prov);
                this.province.province.sort();
            },
            plotAndamento: function (regione, elementId, plotTitle) {
                var andamento;
                if (regione == null)
                    andamento = this.nazionale.andamento;
                else
                    andamento = this.regioni.andamento.filter(e => e.denominazione_regione===regione)

                const traces = [
                    getTrace('Totale casi', this.data, andamento.map(e => e.totale_casi), false),
                    getTrace('Totale deceduti', this.data, andamento.map(e => e.deceduti), false),
                    getTrace('Totale Tamponi', this.data, andamento.map(e => e.tamponi), false),
                    getTrace('Attualmente positivi', this.data, andamento.map(e => e.totale_positivi)),
                    getTrace('Nuovi positivi giornalieri', this.data, andamento.map(e => e.nuovi_positivi)),
                    getTrace('Nuovi tamponi giornalieri', this.data, diffArray(andamento.map(e => e.tamponi))),
                    getTrace('Deceduti', this.data, diffArray(andamento.map(e => e.deceduti)))
                ];
                Plotly.newPlot(elementId, traces, getLayout(plotTitle), getConfig());
            },
            plotAndamentoNazionalePercentuali: function () {
                const positivi = this.nazionale.andamento.map(e => e.totale_positivi);
                var traces = [
                    getTrace('Deceduti', this.data, divArray(diffArray(this.nazionale.andamento.map(e => e.deceduti)),positivi)),
                    getTrace('Terapia intensiva', this.data, divArray(this.nazionale.andamento.map(e => e.terapia_intensiva),positivi)),
                    getTrace('Ospedalizzati', this.data, divArray(this.nazionale.andamento.map(e => e.totale_ospedalizzati),positivi)),
                    getTrace('Isolamento domiciliare', this.data, divArray(this.nazionale.andamento.map(e => e.isolamento_domiciliare),positivi))
                ];
                traces.forEach(t => t.hovertemplate = '%{y:,.4%}');

                var layout = getLayout('Percentuali rispetto agli attualmente positivi');
                layout.yaxis = { tickformat: ',.0%' };

                Plotly.newPlot('andamentoNazionalePercentuali', traces, layout, getConfig());
            },
            updateRegione: function () {
                var regione = $('#regioneSelect').find(':selected').text();
                this.plotAndamento(regione, 'andamentoRegioni', 'Andamento regione ' + regione);
            },
            plotAndamentoProvince: function (provincia) {
                Plotly.newPlot(
                    'andamentoProvince',
                    [getTrace('Totale casi', this.data, this.province.andamento
                        .filter(e => e.denominazione_provincia===provincia)
                        .map(e => e.totale_casi))],
                    getLayout('Andamento provincia di ' + provincia),
                    getConfig());
            },
            updateProvincia: function () {
                var provincia = $('#provinciaSelect').find(':selected').text();
                this.plotAndamentoProvince(provincia);
            },
            processPercentuali: function () {
                var nuoviDeceduti = getFromEnd(this.nazionale.andamento,-1).deceduti - getFromEnd(this.nazionale.andamento,-2).deceduti;
                this.nazionale.percentuali.decessi_per_caso_positivo =
                    nuoviDeceduti / getFromEnd(this.nazionale.andamento,-2).totale_positivi * 100;

                this.nazionale.percentuali.ospedalizzati_per_caso_positivo =
                    getFromEnd(this.nazionale.andamento,-1).totale_ospedalizzati /
                    getFromEnd(this.nazionale.andamento,-1).totale_positivi * 100;

                this.nazionale.percentuali.terapia_intensiva_per_caso_positivo =
                    getFromEnd(this.nazionale.andamento,-1).terapia_intensiva /
                    getFromEnd(this.nazionale.andamento,-1).totale_positivi * 100;
            }
        },
        filters: { formatDateDDMMYYYY, formatString, formatNumber, formatPercentage },
        mounted() {
            var tab = $('#tab');
            this.mobileAccess = ( ( window.innerWidth <= 800 ) && ( window.innerHeight <= 600 ) );
            if (this.mobileAccess)
                tab.addClass('nav-fill');
            tab.hide();
            this.timer = setTimeout(() => this.loadingError = true,10000)
            this.getData();
        }
    })

</script>

</html>
